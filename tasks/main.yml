---
# tasks file for cyhy_core

#
# Grab the cyhy-core code
#
- name: Create the /var/local/cyhy/core directory
  file:
    path: /var/local/cyhy/core
    state: directory

- name: Download and untar the cyhy-core tarball
  unarchive:
    src: "https://api.github.com/repos/jsf9k/cyhy-core/tarball/develop?\
    access_token={{ github_oauth_token }}"
    dest: /var/local/cyhy/core
    remote_src: yes
    extra_opts:
      - "--strip-components=1"

#
# Install cyhy-core
#
- name: Install cyhy-core
  pip:
    name: file:///var/local/cyhy/core

#
# Download and extract GeoIP database.
#
- name: Set a fact for the remote file checksum url
  set_fact:
    checksum_url: "https://download.maxmind.com/app/geoip_download?edition_id=\
    GeoIP2-City&license_key={{ geoip_license_key }}&suffix=tar.gz.md5"

- name: Create the /usr/local/share/GeoIP/ directory
  file:
    path: /usr/local/share/GeoIP/
    state: directory

- name: Check if the downloaded tar.gz file exists
  stat:
    path: /usr/local/share/GeoIP/GeoIP2-City.tar.gz
    checksum_algorithm: md5
  register: tarball

- name: Check to see if a new version is available
  set_fact:
    get_update: "{{ True if (not tarball.stat.exists or \
    tarball.stat.checksum != lookup('url', '{{ checksum_url }}')) else False }}"

- name: Download, verify, and extract the latest database version
  block:
    - name: Get GeoIP database and check (md5)
      get_url:
        url: "https://download.maxmind.com/app/geoip_download?edition_id=\
        GeoIP2-City&license_key={{ geoip_license_key }}&suffix=tar.gz"
        dest: /usr/local/share/GeoIP/GeoIP2-City.tar.gz
        checksum: "md5:{{ lookup('url', '{{ checksum_url }}') }}"
    - name: Extract GeoIP database
      unarchive:
        src: /usr/local/share/GeoIP/GeoIP2-City.tar.gz
        dest: /usr/local/share/GeoIP/
        remote_src: yes
        extra_opts:
          - "--strip-components=1"
  when: get_update
